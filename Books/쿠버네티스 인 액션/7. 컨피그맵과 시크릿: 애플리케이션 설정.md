# 컨피그맵과 시크릿: 애플리케이션 설정

## 컨테이너화된 애플리케이션 설정

설정 데이터를 저장하는 쿠버네티스 리소스를 컨피그맵이라고 한다.  컨피그맵을 사용하여 아래와 같은 방법으로 애플리케이션을 구성할 수 있다.

* 컨테이너에 명령줄 인수 전달
* 각 컨테이너를 위한 사용자 정의 환경변수 지정
* 특수한 유형의 볼륨을 통해 설정 파일을 컨테이너에 마운트

<br/>

## 컨테이너에 명령줄 인자 전달

### 도커에서 명령어와 인자 정의

Dockerfile에서 ENTRYPOINT는 컨테이너가 시작될 때 호출될 명령어이고,  
CMD는 ENTRYPOINT에 전달되는 인자를 정의한다.  

CMD 명령어를 사용해 이미지가ㅣ 실행될 때 실행할 명령어를 지정할 수 있지만, 올바른 방법은 ENTRYPOINT 명령어로 실행하고 기본 인자로 정의하려는 경우에만 CMD를 지정하는 것이다.  

* shell 형식 - ENTRYPOINT node app.js
* exec 형식 - ENTRYPOINT ["node", "app.js"]

exec 형식으로 하면 컨테이너 내부에서 node 프로세스를 직접 실행한다.  

shell 형식으로 하게되면 쉘 프로세스를 거치게 된다. 이는 불필요하므로 exec 형식을 사용해 실행한다.  

```shell
#!/bin/bash
trap "exit" SIGINT
INTERVAL=$1
echo Configurerd to generate new fortune every $INTERVAL seconds
mkdir -p /var/htdocs
while :
do
  echo $(date) Writing fortune to /var/htdocs/index.html
  /usr/games/fortune > /var/htdocs/index.html
  sleep $INTERVAL
done
```

```dockerfile
FROM ubuntu:latest
RUN apt-get update; apt-get -y install fortune
ADD fortuneloop.sh /bin/fortuneloop.sh
ENTRYPOINT ["/bin/fortuneloop.sh"]
CMD ["10"]
```

이대로 이미지를 만들고 돌려보면  

```sh
Configurerd to generate new fortune every 10 seconds
Mon May 29 10:27:51 UTC 2023 Writing fortune to /var/htdocs/index.html
```

위와 같이 나오게 된다. ``docker run -it [image name] 15`` 로 하면 10seconds가 아닌 15로 찍히는 것을 확인할 수가 있다.  

<br/>

### 쿠머네티스에서 명령과 인자 재정의

도커에서의 ENTRYPOINT는 쿠버네티스에서 command,  

CMD는 args로 지정할 수 있다.  

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: fortune2
spec:
  containers:
  - image: luksa/fortune:args
    args: ["2"]
...
```

위와 같이 인자를 넘겨줄 수 있다. 여러 개의 인자를 가진 경우에는 

```yaml
args:
- foo
- bar
- "15"
```

와 같이 표현할 수 있다.

<br/>

## 컨테이너의 환경변수 설정

```shell
#!/bin/bash
trap "exit" SIGINT
echo Configurerd to generate new fortune every $INTERVAL seconds
mkdir -p /var/htdocs
while :
do
  echo $(date) Writing fortune to /var/htdocs/index.html
  /usr/games/fortune > /var/htdocs/index.html
  sleep $INTERVAL
done
```

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: fortune2
spec:
  containers:
  - image: luksa/fortune:args
    env:
    - name: INTERVAL
      value: "30"
...
```

기존의 sh에서 $INTERVAL을 초기화하던 행을 지우고, pod 매니페스트에서 env를 설정해준다.  

```yaml
env:
- name: FIRST_VAR
  value: "foo"
- name: SECOND_VAR
  value: "$(FIRST_VAR)bar"
```

이렇게 다른 환경변수를 참조할 수도 있다.  

