# 엘라스틱서치 살펴보기

## 엘라스틱서치를 구성하는 개념

### 기본용어

#### 인덱스

데이터 저장공간, 하나의 타입만 가지며 물리적 노드에 여러 개의 논리적인 인덱스 생성 가능.  
검색 시 인덱스 이름으로 문서 데이터를 검색하며, 여러 개의 인덱스를 동시에 검색하는 것도 가능.  

엘라스틱서치를 분산 환경으로 구성하면 하나의 인덱스가 여러 노드에 분산 저장되어 관리된다. 기본적으로 5개의 프라이머리 샤드와 1개의 레플리카 샤드 세트를 생성한다. 이름은 모두 소문자여야 한다. 인덱스가 없는 상태에서 데이터가 추가된다면 데이터를 이용해 인덱스가 자동으로 생성된다.  

#### 샤드

색인된 문서는 하나의 인덱스게 담기고 인덱스 내부에 색인된 데이터는 물리적인 공간에 여러 개의 파티션으로 나뉘어 구성되는데, 이 파티션을 엘라스틱서치에서는 샤드라고 부른다. 엘라스틱서치는 다수의 샤드로 문서를 분산 저장하기에 데이터 손실 위험을 최소화한다.  

#### 타입

인덱스의 논리적 구조를 의미

#### 문서

엘라스틱서치에서 데이터가 저장되는 최소 단위. DB의 row에 해당함. 중첩 구조를 지원하기 때문에 문서 안에 문서를 저장하는 것도 가능  

#### 필드

DB의 column 개념. 하나의 필드는 다수의 데이터 타입을 가질 수 있다. 영화 제목을 검색할 때 매칭 검색을 하거나 초성을 이용한 검색이 모두 지원되도록 2개의 데이터 타입을 가지게 하는 등.  

#### 매핑

문서의 필드와 필드의 속성을 정의하고 그에 따른 색인 방법을 정의하는 프로세스

### 노드의 종류

#### 마스터 노드

인덱스를 생성, 삭제하는 등 클러스터와 관련된 전반적인 작업을 담당한다. 네트워크 속도가 빠르고 지연이 없는 노드를 마스터 노드로 선정해야 한다. 다수의 노드를 마스터 노드로 설정해도 결과적으로 하나의 노드만이 마스터 노드로 선출되어 동작한다. 

#### 데이터 노드

문서가 실제로 저장되는 노드. 색인 작업은 CPU, 메모리, 스토리지 같은 컴퓨팅 리소스를 많이 소모하기 때문에 리소스 모니터링이 필요하다. 마스터 노드와 가능한 분리해서 구성하는 것이 좋다.  

#### 코디네이팅 노드

데이터 노드, 마스터 노드, 인제스트 노드의 역할을 하지 않고, 들어온 요청을 단순히 라운드로빈 방식으로 분산시켜 주는 노드  

#### 인제스트 노드

색인에 앞서 데이터를 전처리하기 위한 노드. 데이터의 포맷을 변경하기 위해 스크립트로 전처리 파이프라인을 구성하고 실행할 수 있다.  

### 클러스터, 노드, 샤드

하나의 클러스터 안에 여러 노드들이 있고 노드들 안에 여러 샤드들이 들어간다.  

만약 1클 2노 4샤 라고 치면 1클안에 2노가 들어가고 각 노드안에 2샤 씩 들어갈 것이다.  
노드가 3개 프라이머리 샤드가 3개, 레플리카 샤드가 1개라면 각 노드 안에 프라이머리 샤드 1개, 레플리카 샤드가 1개 이렇게 분배될 것이다.  

<br/>

## 엘라스틱서치에서 제공하는 주요 API

### API의 종류

주요 API  

* 인덱스 관리 API(Indices API): 인덱스 관리
* 문서 관리 API(Document API): 문서의 추가/수정/삭제
* 검색 API(Search API): 문서 조회
* 집계 API(Aggregation API): 문서 통계

엘라스틱서치는 사용 편의성을 위해 스키마리스라는 기능을 제공한다. 이는 인덱스 생성 없이 문서를 추가하더라도 문서가 색인되도록 지원하는 편의 기능이다. 내부적으로 인덱스의 존재 여부를 확인하고 존재하지 않는다면 문서를 분석해서 문서가 색인될 수 있게 인덱스를 자동으로 생성한다.  

### 스키마리스 기능은 가급적이면 사용하지 말자

자동으로 인덱스 생성 시 데이터 타입이 default 값들이 들어간다. 가령 String 을 넣으면 text 타입고 keyword 타입을 동시에 제공하는 멀티필드 기능으로 구성되는데, 하나의 타입만 필요한 경우도 있을 것이다. 이렇듯 데이터 공간의 낭비를 초래한다. 검색 품질 또한 떨어지게 되는 것이다.  

### 인덱스 관리 API

