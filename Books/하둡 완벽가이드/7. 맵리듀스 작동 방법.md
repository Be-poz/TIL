# 맵리듀스 작동 방법

## 맵리듀스 잡 실행 상세 분석

잡의 과정은 상위 수준에서 보면 다섯 개의 독립적인 단계로 구분되어 있다.  

* **클라이언트**: 맵리듀스 잡을 제출한다
* **YARN 리소스 매니저**: 클러스터 상에 계산 리소스의 할당을 제어한다.
* **YARN 노드 매니저**: 클러스터의 각 머신에서 계산 컨테이너를 시작하고 모니터링한다.
* **맵리듀스 애플리케이션 마스터**: 맵리듀스 잡을 수행하는 각 태스크를 제어한다. 애플리케이션 마스터와 맵리듀스 태스크는 컨테이너 내에서 실행되며, 리소스 매니저는 잡을 할당하고 노드 매니저는 태스크를 관리하는 역할을 맡는다.
* **분산 파일시스템**: 다른 단계 간에 잡 리소스 파일들을 공유하는 데 사용된다.

<img width="713" alt="image" src="https://github.com/Be-poz/TIL/assets/45073750/dd73ac0c-7119-4fe5-bc85-8ead66c20575">

### 잡 제출

Job의 submit() 메서드는 내부의 JobSubmitter 인스턴스를 생성하고 submitJobInternal() 메서드를 호출한다.  
일단 잡을 제출하면 waitForCompletion() 메서드가 1초에 한 번씩 잡의 진행 상황을 조사하여 변경 내역이 있으면 콘솔로 보여준다. 잡이 성공적으로 완료되면 잡 카운터를 보여준다.  

<img width="706" alt="image" src="https://github.com/Be-poz/TIL/assets/45073750/d63875cb-2e9d-45c9-8883-57dcb8e12070">

### 잡 초기화

리소스 매니저가 submitApplication() 메서드의 호출을 받으면 YARN 스케줄러에 요청을 전달한다. 스케줄러는 컨테이너를 하나 할당하고, 리소스 매니저는 노드 매니저의 운영 규칙에 따라 애플리케이션 마스터 프로세스를 시작한다.  

맵리듀스 잡의 애플리케이션 마스터는 자바 어플리케이션이며 메인 클래스는 MRAppMaster다.  

애플리케이션 마스터는 맵리듀스 잡을 구성하는 태스크를 실행할 방법을 결정해야 한다. 잡의 크기가 작다면 애플리케이션 마스터는 태스크를 자신의 JVM에서 실행할 수도 있다. 이러한 상호아에 적합한 경우는 병렬 처리를 위해 새로운 컨테이너에 태스크를 할당하고 실행하는 오버헤드가 단일 노드에서 순차적으로 실행하는 방식에 비해 유리하다고 판단될 때다. 이러한 잡을 **우버되었다** 고 말하며, **우버 태스크**로 실행된다고 하기도 한다.  

작은 잡이란 10개 미만의 매퍼와 하나의 리듀서, HDFS 블록 하나보다 작은 크기의 입력을 말한다.  

### 태스크 할당

잡을 우버 태스크로 실행하기 적합하지 않다면 애플리케이션 마스터는 리소스 매니저에 잡의 모든 맵과 리듀스 태스크를 위한 컨테이너를 요청한다(8단계). 맵 태스크요청이 먼저며 리듀스 태스크 요청보다 우선순위가 높다.  

### 태스크 실행

리소스가 태스크에 할당되면 애플리케이션 마스터는 노드 매니저와 통신하며 컨테이너를 시작한다(9a, 9b 단계). 

스트리밍은 사용자가 제공한 실행 파일을 시작하고 이와 통신하기 위한 목적을 가진 특별한 맵과 리듀스 태스크를 실행한다.  

스트리밍 태스크는 표춘 입출력 스트림을 통해 프로세스와 통신한다. 태스크가 실행되는 동안 자바 프로세스는 키-값 쌍을 외부 프로세스에 전달하고, 이를 사용자 정의 맵과 리듀스 함수로 처리한 뒤, 최종적으로 출력 키-값 쌍을 자바 프로세스에 돌려준다. 따라서 노드 매니저 관점에서는 자식 프로세스가 마치 맵과 리듀스 코드를 스스로 실행한 것처럼 보일 것이다.  

<img width="704" alt="image" src="https://github.com/Be-poz/TIL/assets/45073750/60e64d3a-4cb9-4e8b-8d6d-cb7f4bb44ede">

태스크가 수행되는 동안 태스크는 자신의 진행 상황을 추적한다.  

<img width="711" alt="image" src="https://github.com/Be-poz/TIL/assets/45073750/87704b93-7d5a-40a2-bc36-4fefbb490571">

### 잡 완료

애플리케이션 마스터가 마지막 태스크가 완료되었다는 통지를 받으면 잡의 상태를 'successful' 으로 변경한다.  
이제 잡이 상태 정보를 폴링하면 해당 잡이 성공적으로 완료되었음을 알게 되고, 사용자에게 통지할 메시지를 출력한 뒤 waitForCompletion() 메서드가 반환된다. 이 시점에 잡 통계와 카운터가 콘솔에 출력된다.  

<br/>

## 셔플과 정렬

맵리듀스는 모든 리듀서의 입력이 키를 기준으로 정렬되는 것을 확실히 보장한다. 시스템이 이러한 정렬을 수행하고 맵의 출력을 리듀서의 입력으로 전송하는 과정을 **셔플**이라고 한다.  



<img width="710" alt="image" src="https://github.com/Be-poz/TIL/assets/45073750/15d270fb-530b-4cd5-ad66-7f54a2754e70">

---

