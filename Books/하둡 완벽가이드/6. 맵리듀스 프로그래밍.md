# 맵리듀스 프로그래밍

```xml
// configuration-1.xml
<?xml version="1.0"?>
<configuration>
  <property>
    <name>color</name>
    <value>yellow</value>
      <description>Color</description>
  </property>
  <property>
    <name>weight</name>
    <value>heavy</value>
    <final>true</final>
    <description>Weight</description>
  </property>
  <property>
    <name>size</name>
    <value>10</value>
    <description>Size</description>
  </property>
  <property>
    <name>size-weight</name>
    <value>${size}, ${weight}</value>
    <description>Size and Weight</description>
  </property>
</configuration>

//configuration-2.xml
<?xml version="1.0"?>
<configuration>
  <property>
    <name>size</name>
    <value>12</value>
    <description>Size</description>
  </property>
  <property>
    <name>weight</name>
    <value>heavy</value>
    <description>Light</description>
  </property>
</configuration>
```

```java
import org.apache.hadoop.conf.Configuration;

Configuration conf = new Configuration();
conf.addResource("configuration-1.xml");
assertThat(conf.get("color")).isEqualTo("yellow");
assertThat(conf.get("size")).isEqualTo("10");
assertThat(conf.getInt("size", 0)).isEqualTo(10);
assertThat(conf.get("weight")).isEqualTo("heavy");
assertThat(conf.get("size-weight")).isEqualTo("10, heavy");

conf.addResource("configuration-2.xml");
assertThat(conf.get("weight")).isEqualTo("heavy");
assertThat(conf.get("size")).isEqualTo("12");
```

``org.apache.hadoop.conf`` 아래에 있는 ``Configuration`` 클래스 인스턴스를 이용하여 XML 파일로부터 속성 정보를 읽을 수 있다. 여러 리소스를 읽을 때에는 이전에 정의된 속성을 오버라이드한다. final이 true면 오버라이드 되지 않는다.  

<Br/>

```java
import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.conf.Configured;
import org.apache.hadoop.util.Tool;
import org.apache.hadoop.util.ToolRunner;

public class ConfigurationPrinter extends Configured implements Tool {

    static {
        Configuration.addDefaultResource("hdfs-default.xml");
        Configuration.addDefaultResource("hdfs-site.xml");
        Configuration.addDefaultResource("yarn-default.xml");
        Configuration.addDefaultResource("yarn-site.xml");
        Configuration.addDefaultResource("mapred-default.xml");
        Configuration.addDefaultResource("mapred-site.xml");
    }

    @Override
    public int run(String[] args) throws Exception {
        Configuration conf = getConf();
        for (Entry<String, String> entry : conf) {
            System.out.printf("%s=%s\n", entry.getKey(), entry.getValue());
        }
        return 0;
    }

    public static void main(String[] args) throws Exception {
        int exitCode = ToolRunner.run(new ConfigurationPrinter(), args);
        System.out.println(exitCode);
    }
}
```

하둡은 명령행에서 잡을 쉽게 실행할 수 있도록 몇 가지 헬퍼 클래스를 제공한다.  

Configurable 인터페이스를 구현한 Configured 클래스를 상속받아 ConfigurationPrinter를 만든다.  
Configured 클래스를 상속받으면 Tool 인터페이스의 부모인  Configurable 인터페이스를 쉽게 구현할 수 있다.  
run() 메서드는 Configurable의 getConf() 메서드를 통해 Configuration 객체를 반복적으로 얻고 모든 속성을 표준 출력으로 출력한다.  

<br/>

```java
import java.io.IOException;
import org.apache.hadoop.io.*;
import org.apache.hadoop.mapreduce.Mapper;

public class MaxTemperatureMapper extends Mapper<LongWritable, Text, Text, IntWritable> {
  
  @Override
  public void map(LongWritable key, Text value, Context context)
      throws IOException, InterruptedException {
    
    String line = value.toString();
    String year = line.substring(15, 19);
    int airTemperature = Integer.parseInt(line.substring(87, 92));
    context.write(new Text(year), new IntWritable(airTemperature));
  }
}
```

```java
public class MaxTemperatureMapperTest {

  @Test
  public void processesValidRecord() throws IOException, InterruptedException {
    Text value = new Text("0043011990999991950051518004+68750+023550FM-12+0382" +
                                  // Year ^^^^
        "99999V0203201N00261220001CN9999999N9-00111+99999999999");
                              // Temperature ^^^^^
    new MapDriver<LongWritable, Text, Text, IntWritable>()
      .withMapper(new MaxTemperatureMapper())
      .withInput(new LongWritable(0), value)
      .withOutput(new Text("1950"), new IntWritable(-11))
      .runTest();
  }
}
```

위와 같이  ``MapDriver``를 이용해서 Mapper 테스트가 가능하다.  

```java
public class MaxTemperatureReducer
  extends Reducer<Text, IntWritable, Text, IntWritable> {

  @Override
  public void reduce(Text key, Iterable<IntWritable> values,
      Context context)
      throws IOException, InterruptedException {
    
    int maxValue = Integer.MIN_VALUE;
    for (IntWritable value : values) {
      maxValue = Math.max(maxValue, value.get());
    }
    context.write(key, new IntWritable(maxValue));
  }
}
```

```java
public class MaxTemperatureReducerTest {
  
  @Test
  public void returnsMaximumIntegerInValues() throws IOException,
      InterruptedException {
    new ReduceDriver<Text, IntWritable, Text, IntWritable>()
      .withReducer(new MaxTemperatureReducer())
      .withInput(new Text("1950"),
          Arrays.asList(new IntWritable(10), new IntWritable(5)))
      .withOutput(new Text("1950"), new IntWritable(10))
      .runTest();
  }
}
```

Reducer 또한 테스트가 가능하다.  

<br/>

