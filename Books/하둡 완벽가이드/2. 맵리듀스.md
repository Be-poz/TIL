# 맵리듀스

맵리듀스는 데이터 처리를 위한 프로그래밍 모델이다.  하둡은 다양한 언어로 작성된 맵리듀스 프로그램을 구동시킬 수 있다.  
맵리듀스는 태생 자체가 병행성을 고려하여 설계되었고, 누구든지 충분한 장비만 갖추고 있다면 대규모 데이터 분석을 할 수 있다.  

<br/>

## 하둡으로 데이터 분석하기

하둡이 제공하는 병렬 처리의 이점을 이용하기 위해서는 우리 요구사항을 맵리듀스 잡으로 다시 표현할 필요가 있다.  

### 맵과 리듀스

맵리듀스 작업은 크게 맵 단계와 리듀스 단계로 구분된다. 각 단계는 입력과 출력으로 키-값의 쌍을 가지며, 그 타입은 프로그래머가 선택한다. 또한 프로그래머는 맵 함수와 리듀스 함수를 작성해야 한다.  

데이터는 국립기후자료센터의 기후 데이터를 기반으로 예를 들어 말해본다. 먼저 데이터셋의 각 행의 타입을 텍스트로 인식하는 텍스트 입력 포맷을 선택한다. 값은 각 행이고, 키는 파일의 시작부에서 각 행이 시작되는 지점까지의 오프셋이다.  

맵 함수는 데이터의 준비 단계로, 연도별 최고 기온을 찾는 리듀스 함수를 위해 데이터를 제공하는 역할을 맡는다.  
또한 잘못된 레코드를 걸러주는 작업은 맵 함수에서 수행하는 것이 적합하며, 여기서는 기온 필드의 값이 누락되거나 이상하거나 문제가 있는 레코드를 제거하는 작업을 수행한다.  

```
0006701....
004301.....

있으면

(0, 006701...)    	각 행이 시작되는 지점까지의 오프셋, 각 행
(106, 004301...)
```

맵 함수는 연도와 기온을 추출하여 출력으로 내보낸다.  

```
(1950, 0)
(1950, 22)
(1950, -11)
...
```

맵 함수의 출력이 리듀스 함수의 입력으로 보내지는 과정은 맵리듀스 프레임워크에 의해 처리된다.  
이 과정에서 키-값 쌍은 키를 기준으로 정렬되고 그룹화된다. 여기서 키는 연도고 값은 기온이다.  

```
(1949, [111, 78])
(1950, [0, 22, -11])
```

연도별로 측정된 모든 기온갑싱 하나의 리스트로 묶인다. 리듀스 함수는 리스트 전체를 반복하여 최고 측정값을 추출한다.

```
(1949, 111)
(1950, 22)
```

<img width="720" alt="image" src="https://github.com/Be-poz/TIL/assets/45073750/91822e41-bf3b-4f21-bbb4-ebef178b6b5d">

<br/>

## 분산형으로 확장하기

하둡은 데이터의 일부분이 저장된 클러스터의 각 머신에서 맵리듀스 프로그램을 실행한다.  
이를 위해 하둡은 YARN이라 불리는 하둡 자원 관리 시스템을 이용한다.

### 데이터 흐름

맵리듀스 **잡**은 클라이언트가 수행하는 작업의 기본 단위다.  
잡은 입력 데이터, 맵리듀스 프로그램, 설정 정보로 구성된다. 하둡은 잡을 **맵 태스크**와 **리듀스 태스크**로 나뉘어 실행한다.  
각 태스크는 YARN을 이용하여 스케줄링되고 클러스터의 여러 노드에서 실행된다.  
특정 노드의 태스크 하나가 실패하면 자동으로 다른 노드를 재할당하여 다시 실행된다.  

하둡은 맵리듀스 잡의 입력을 **입력 스플릿** 또는 단순히 **스플릿**이라고 부르는 고정 크기 조각으로 분리한다.  
하둡은 각 스플릿마다 하나의 맵 태스크를 생성하고 스플릿의 각 **레코드**를 사용자 정의 맵 함수로 처리한다.  

스플릿으로 분리된 많은 조각을 병렬로 처리한다면 부하 분산에 더 좋은 효과를 볼 수 있다. 그렇지만 스플릿 크기가 너무 작으면 스플릿 관리와 맵 태스크 생성을 위한 오버헤드 때문에 잡의 실행 시간이 증가한다는 단점이 있다. 일반적인 잡의 적절한 스플릿 크기는 HDFS 블록의 기본 크기인 128MB가 적당하다고 알려져 있다. HDFS 블록의 크기는 클러스터 설정에 따라 다르고 파일을 생성할 때 개별로 지정할 수 있다.  

<img width="401" alt="image" src="https://github.com/Be-poz/TIL/assets/45073750/4631d3f1-138f-4a2a-a394-766839f4069d">

하둡은 HDFS 내의 입력 데이터가 있는 노드에서 맵 태스크를 실행할 때 가장 빠르게 작동한다.  
이를 **데이터 지역성 최적화**라고 하고 클러스터의 중요한 공유 자원인 네트워크 대역폭을 사용하지 않는 방법이다.  

그러나 맵 태스크의 입력 스플릿에 해당하는 HDFS 블록 복제본이 저장된 세 개의 노드 모두 다른 맵 태스크를 실행하여 여유가 없는 상황이 발생할 수 있는데 이런 상황에서 잡 스케줄러는 블록 복제본이 저장된 동일 랙에 속한 다른 노드에서 가용한 맵 슬롯을 찾는다. 그리고 드물게 외부 랙의 노드가 선택될 수 있는데 이때에는 랙 간 네트워크 전송이 불가피하게 일어난다.  

맵 태스크의 결과는 HDFS가 아닌 로컬 디스크에 저장된다. 맵의 결과는 리듀스가 최종 결과를 생성하기 위한 중간 결과물이고, 잡이 완료된 후 맵의 결과는 그냥 버려지기 때문이다. 따라서 맵의 결과를 HDFS에 저장하는 것은 내부 복제과정을 추가하는 것이 되어 적절치 않다. 리듀스 태스크로 모든 결과를 보내기 전에 맵 태스크가 실패한다면 하둡은 자동으로 해당 맵 태스크를 다른 노드에 할당하여 맵의 출력을 다시 생성할 것이다.  

리듀스 태스크는 일반적으로 모든 매퍼의 출력 결과를 입력으로 받기 때문에 데이터 지역성의 장점이 없다.  
일반적으로 리듀스의 결과는 안정성을 위해 HDFS에 저장된다. 리듀스 출력에 대한 HDFS 블록의 첫 번째 복제본은 로컬 노드에 저장되고, 나머지 복제본은 외부 랙에 저장된다. 따라서 리듀스의 결과를 출력하는 것은 네트워크 대역폭을 소모하지만 일반적으로 HDFS 쓰기 파이프라이넹 소모되는 대역폭과 비슷한 수준이다.  

<img width="895" alt="image" src="https://github.com/Be-poz/TIL/assets/45073750/7663b50f-95f2-4b07-9fc7-f6d290fdce5b">

리듀스 태스크의 수는 입력 크기와 상관없이 독립적으로 지정할 수 있다.  
리듀스가 여럿이면 맵 태스크는 리듀스 수만큼 파티션을 생성하고 맵의 결과를 각 파티션에 분배한다.  
해시 함수로 키를 분배하는 기본 파티셔너를 주로 사용한다.  

리듀스 수 선택은 잡의 실행 시간에 미치는 영향이 매우 크므로 튜닝이 필요하다.  

<img width="900" alt="image" src="https://github.com/Be-poz/TIL/assets/45073750/4509efdd-94f9-45c7-85ea-164becb177ed">

리듀스 태스크가 아예 없을 수도 있는데, 셔플이 필요 없고 모든 처리 과정을 완전히 병렬로 처리하는 경우에 적합하다.  

<br/>

### 컴바이너 함수

클러스터에서 맵리듀스 잡이 사용하는 네트워크 대역폭은 한계가 있기 때문에 맵과 리듀스 태스크 사이의 데이터 전송을 최소화할 필요가 있다. 하둡은 맵의 결과를 처리하는 **컴바이너 함수**를 허용한다.  

```
(1950, 0)
(1950, 20)
(1950, 10)
```

데이터의 첫 번째 맵의 결과는 위와 같고,  

```
(1950, 25)
(1950, 15)
```

두 번째 결과는 위와 같다. 이 모든 값을 하나의 리스트에 담아서 ``(1950, [0, 20, 10, 25, 15])``와 같이 리듀스 함수로 전달한다. 리스트의 최고기온은 25도이므로 리듀스의 결과는 ``(1950, 25)`` 가 된다.  

이 경우 각 맵의 출력에서 최고 기온을 찾는 리듀스 함수를 컴바이너 함수로 재사용할 수 있다.  

하지만 만약 평균을 구하는 경우에는 mean 함수를 컴바이너로 사용할 수 없을 것이다.  

또한 컴바이너 함수가 리듀스 함수를 완전히 대체할 수도 없다. 맵 단계에서 컴바이너 함수를 쓰더라도 리듀스 함수는 서로 다른 맵에서 오는 같은 키의 레코드를 여전히 처리해야 한다. 컴바이너를 사용하면 매퍼와 리듀서 사이의 셔플 단계에서 전송되는 데이터양을 줄이는 데 큰 도움이 된다. 따라서 이러한 이유만으로도 맵리듀스 잡에 컴바이너의 적용 여부를 검토하는 것은 충분한 가치가 있다.  

<Br/>

## 하둡 스트리밍

하둡은 자바 외에 다른 언어로 맵과 리듀스 함수를 작성할 수 있는 맵리듀스 API를 제공한다.  
**하둡 스트리밍**은 하둡과 사용자 프로그램 사이의 인터페이스로 유닉스 표준 스트림을 사용한다. 따라서 사용자는 표준 입력을 읽고 표준 출력으로 쓸 수 있는 다양한 언어를 이용하여 맵리듀스 프로그램을 작성할 수 있다.  

---

